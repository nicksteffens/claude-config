module Api::V4
  class UsersController < BaseController
    def me
      render_current_user
    end

    def update
      clear_revisions if params[:revisions].present?
      render_current_user
    end

    private

    def render_current_user
      render json: serialize(
        current_user,
        serializer: Api::V4::CurrentUserSerializer,
        view: :base,
        current_company:,
        revisions: revision_overrides,
        features: current_features,
        preview_auth_token:
      )
    end

    def clear_revisions
      permitted_apps = Rails.application.config.ember_projects.map(&:to_s)
      params[:revisions].each do |app, value|
        session.delete("#{app}_revision") if value.nil? && permitted_apps.include?(app.to_s)
      end
    end

    def revision_overrides
      Rails.application.config.ember_projects.each_with_object({}) do |app, overrides|
        overrides[app.to_sym] = session["#{app}_revision"]
      end
    end

    def current_features
      Flip::FeatureSet.instance.definitions.each_with_object({}) do |definition, features|
        features[definition.key] = true if Flip.on? definition.key
      end
    end
  end
end
