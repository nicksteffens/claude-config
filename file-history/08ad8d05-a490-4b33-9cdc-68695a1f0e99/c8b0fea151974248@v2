require "rails_helper"

describe Api::V4::UsersController do
  let(:company) { default_company }
  let(:user) { u = create(:user, email: "test@example.com"); company.permit_access_for(u); u }

  before do
    login user
  end

  context "GET #me" do
    context "when user is authenticated" do
      before do
        get :me, format: :json
      end

      let(:json_user) { JSON.parse(response.body)["data"] }

      it "returns the serialized user id and email" do
        expect(json_user["id"]).to eq(user.id.to_s)
        expect(json_user["email"]).to eq(user.email)
      end

      it "returns the serialized user first and last name" do
        expect(json_user["first_name"]).to eq(user.first_name)
        expect(json_user["last_name"]).to eq(user.last_name)
      end

      it "returns the serialized user company and roles" do
        expect(json_user).to have_key("current_company")
        expect(json_user["is_admin"]).to eq(user.is_admin)
        expect(json_user["is_operator"]).to eq(user.is_operator)
        expect(json_user["is_director"]).to eq(user.director?(company))
        expect(json_user["is_internal_user"]).to eq(user.is_internal_editor?)
      end

      it "returns additional serialized user attributes" do
        expect(json_user).to have_key("current_role")
        expect(json_user).to have_key("features")
        expect(json_user).to have_key("has_multiple_companies")
        expect(json_user).to have_key("preview_auth_token")
        expect(json_user).to have_key("revisions")
      end
    end
  end

  context "PATCH #update" do
    let(:json_response) { JSON.parse(response.body) }
    let(:json_user) { json_response["data"] }

    context "when clearing revisions" do
      before do
        session["studio_revision"] = "abc123"
        session["canvas_revision"] = "def456"
      end

      it "clears a single revision when passed null" do
        patch :update, params: { revisions: { studio: nil } }, format: :json, as: :json

        expect(response).to have_http_status(:ok)
        expect(session["studio_revision"]).to be_nil
        expect(session["canvas_revision"]).to eq("def456")
      end

      it "clears multiple revisions when passed null" do
        patch :update, params: { revisions: { studio: nil, canvas: nil } }, format: :json, as: :json

        expect(response).to have_http_status(:ok)
        expect(session["studio_revision"]).to be_nil
        expect(session["canvas_revision"]).to be_nil
      end

      it "returns updated revisions in response" do
        patch :update, params: { revisions: { studio: nil } }, format: :json, as: :json

        expect(json_user["revisions"]["studio"]).to be_nil
        expect(json_user["revisions"]["canvas"]).to eq("def456")
      end

      it "does not clear revisions when value is not null" do
        patch :update, params: { revisions: { studio: "keep" } }, format: :json, as: :json

        expect(session["studio_revision"]).to eq("abc123")
      end

      it "does not clear revisions for invalid app names" do
        session["malicious_key_revision"] = "should_remain"

        patch :update, params: { revisions: { malicious_key: nil } }, format: :json, as: :json

        expect(session["malicious_key_revision"]).to eq("should_remain")
      end
    end

    context "when no revisions param is passed" do
      it "returns the current user without modification" do
        patch :update, format: :json

        expect(response).to have_http_status(:ok)
        expect(json_user["id"]).to eq(user.id.to_s)
      end
    end
  end
end
